<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Twitter Tweets Analysis</title>
    <script src="https://unpkg.com/vis-network@8.4.1/dist/vis-network.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/vis-network@8.4.1/dist/dist/vis-network.min.css">
</head>

<body>
    <label for="term">Search Tweets:</label>
    <input id="term" name="term" type="text">
    <input onclick="analyzeTweets()" type="button" value="Search">

    <div id="output"></div>
    <div id="graph"></div>
    <script>
        // Take the user search term and get back comprehend results
        async function analyzeTweets() {
            // Clear existing graph / output if any
            document.querySelector("#output").innerHTML = "";
            document.querySelector("#graph").innerHTML = "";

            const term = document.querySelector("#term").value.trim();

            if (!term) {
                alert("No blanks");
                return;
            }

            const ANALYZE_URL = `https://97akk4n2mg.execute-api.us-east-1.amazonaws.com/Prod/analyze`;

            try {
                const resp = await fetch(ANALYZE_URL, {
                    method: "POST",
                    body: term
                });

                const json = await resp.json();

                document.querySelector("#output").innerHTML = JSON.stringify(json);
            } catch (e) {
                alert("Error with request");
                console.log(e);
            }

            // Show graph in 3 second
            setTimeout(() => {
                showGraph()
            }, 3000);
        }

        // Build graph for Neptune
        function startGraph(data) {
            const container = document.querySelector("#graph");
            const options = {
                nodes: {
                    shape: "box"
                }
            };
            new vis.Network(container, data, options);
        }

        // Build the graph with vis.js
        async function showGraph() {
            const term = document.querySelector("#term").value.trim();

            if (!term) {
                alert("No blanks");
                return;
            }

            const GET_GRAPH_URL = `https://97akk4n2mg.execute-api.us-east-1.amazonaws.com/Prod/neptune`;

            try {
                const resp = await fetch(GET_GRAPH_URL, {
                    method: "POST",
                    body: term
                });

                const entities = await resp.json();

                // Hardcoded for now, the query to aws returns all of the entities from Neptune for "Pokemon"
                const nodes = new vis.DataSet([{
                    id: 0,
                    label: document.querySelector("#term").value.trim(),
                    color: "#EF8354",
                    font: {
                        color: "white"
                    }
                }]);

                const edges = new vis.DataSet([]);

                for (let i = 0; i < entities.length; i++) {
                    const entity = entities[i];
                    const entityNode = {
                        id: i + 1,
                        label: entity.value, 
                        color: "#04A777",
                        font: {
                            color: "white"
                        }
                    };

                    nodes.add(entityNode);
                    edges.add({
                        from: entityNode.id,
                        to: 0,
                        arrows: "from",
                        label: "has_entity",
                        color: {
                            color: "#A3C3D9"
                        }
                    });
                }

                const nodesView = new vis.DataView(nodes);
                const edgesView = new vis.DataView(edges);

                startGraph({
                    nodes: nodesView,
                    edges: edgesView
                });
            } catch (e) {
                alert("Error building graph");
                console.log(e);
            }
        }
    </script>
</body>

</html>